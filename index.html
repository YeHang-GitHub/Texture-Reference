<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texture Reference</title>
    <style>
        /* Body è®¾ç½®å›ºå®šé«˜åº¦ï¼Œä¸æ»šåŠ¨ï¼Œæ»šåŠ¨æ¡ç”±å†…éƒ¨åŒºåŸŸæ§åˆ¶ */
        body {
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
            background-color: #222;
            color: white;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* é˜²æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ */
        }
        /* é¡¶éƒ¨æ  */
        #topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #333;
            padding: 0 20px;
            height: 50px;
            flex-shrink: 0;
        }
        #header {
            font-size: 1.5em;
        }
        #slider-container {
            display: flex;
            align-items: center;
            position: relative;
        }
        #slider {
            width: 175px;
            height: 5px;
            margin-left: 10px;
        }
        #info-button {
            background: none;
            border: none;
            cursor: pointer;
            color: white;
            font-size: 1.5em;
            margin-left: 5px;
        }
        /* ä¿¡æ¯çª—å£æ ·å¼ */
        #info-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 500px; /* è°ƒæ•´å®½åº¦ */
            text-align: center;
        }
        #info-modal h2 {
            margin-top: 0;
        }
        #info-modal h3 {
            text-align: left;
            margin-bottom: 10px;
            color: #fff;
        }
        #info-modal .row {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        #info-modal .row a {
            color: #4db8ff;
            text-decoration: none;
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        #info-modal .row a:hover {
            text-decoration: underline;
        }
        #info-modal .row a img {
            width: auto; /* ä¿æŒæ­£å¸¸æ¯”ä¾‹ */
            height: 20px;
            margin-right: 5px;
        }
        #info-modal .license {
            margin-top: 20px;
            font-size: 0.8em; /* å­—ä½“æ›´å° */
            color: #aaa;
            text-align: left;
        }
        #info-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
        }
        #info-modal-close:hover {
            color: #f00;
        }
        #alipay-preview {
            display: none;
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            width: 200px; /* è®¾ç½®å®½åº¦è‡³å°‘ä¸º 200px */
            top: 100%; /* è°ƒæ•´ä½ç½®åˆ°æŒ‰é’®ä¸‹æ–¹ */
            left: 50%;
            transform: translateX(-50%);
        }
        #alipay-preview img {
            width: 100%; /* ç¡®ä¿å›¾ç‰‡é€‚åº”å®¹å™¨å®½åº¦ */
            border-radius: 10px;
        }
        #alipay-container:hover #alipay-preview {
            display: block; /* ç¡®ä¿é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤º */
        }
        /* #content å æ®é¡¶éƒ¨æ ä¸‹å‰©ä½™åŒºåŸŸï¼Œå¹¶éšè—è‡ªèº«æ»šåŠ¨ */
        #content {
            display: flex;
            height: calc(100vh - 50px);
            overflow: hidden;
        }
        /* å·¦ä¾§æ–‡ä»¶æ ‘ï¼šå›ºå®šå®½åº¦ï¼Œå¹¶ç‹¬ç«‹å‚ç›´æ»šåŠ¨ */
        #file-tree {
            width: 200px;
            padding: 10px;
            border-right: 2px solid #444;
            overflow-y: auto;
            flex-shrink: 0;
        }
        /* å³ä¾§ç”»å»Šï¼šè‡ªé€‚åº”å®½åº¦ï¼Œå¹¶ç‹¬ç«‹å‚ç›´æ»šåŠ¨ */
        #gallery {
            flex-grow: 1;
            padding: 10px;
            position: relative; /* ç”¨äº JS ç»å¯¹å®šä½å›¾ç‰‡ */
            overflow-y: auto;
            height: 100%;
        }
        /* canvas-containerï¼ˆåŠ¨ç”»åŒºåŸŸï¼‰å¦‚æœéœ€è¦æ”¾åœ¨ç”»å»Šä¸Šå±‚ï¼Œä¸å½±å“æ»šåŠ¨ï¼Œå»ºè®®ä¿æŒç»å¯¹å®šä½ */
        #canvas-container {
            position: absolute;
            top: 50px; /* ä½äºé¡¶éƒ¨æ ä¸‹ */
            left: 222px; /* å·¦ä¾§ï¼š200px æ–‡ä»¶æ ‘ + 22px gapï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰ */
            width: calc(100% - 222px);
            height: calc(100% - 50px);
            z-index: 10;
            pointer-events: none; /* é¿å…é®æŒ¡å³ä¾§ç”»å»Šçš„æ»šåŠ¨æˆ–ç‚¹å‡» */
        }
        .folder {
            cursor: pointer;
            margin: 5px 0;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .folder:hover {
            background-color: #444;
        }
        .folder.selected {
            background-color: #555;
        }
        .file {
            margin-left: 20px;
            cursor: pointer;
            color: #4db8ff;
        }
        .hidden {
            display: none;
            overflow: hidden;
        }
        .thumbnail {
            border-radius: 5px;
            transition: transform 0.2s;
            position: absolute; /* ç”± JS åŠ¨æ€è®¾ç½® top ä¸ left */
        }
        .thumbnail:hover {
            transform: scale(1.02);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
            opacity: 0;
        }
        .modal.show {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 80%;
            max-height: 80%;
            transition: transform 0.2s, transform-origin 0s;
        }
        .modal-content.enlarged {
            transform: scale(5);
        }
        .loading-container {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            align-items: center;
        }
        .loading {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        .loading-text {
            margin-left: 10px;
            color: #fff;
            font-size: 1em;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        .sub-container {
            border-left: 1px solid #444;
            margin-left: 0;
            padding-left: 2px;
        }

        /* æ–°å¢ï¼šç€‘å¸ƒæµå†…éƒ¨å®¹å™¨ */
        #waterfall {
            position: relative;
            width: 100%;
        }

        .fancybox__button--close {
            display: none !important;
        }
        .fancybox__button--close svg {
            display: none !important;
        }

        .carousel__button.is-close {
            display: none !important;
        }

        /* æ”¯ä»˜å®äºŒç»´ç çª—å£æ ·å¼ */
        #alipay-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
        #alipay-modal img {
            max-width: 100%;
            border-radius: 10px;
        }
    </style>
    <!-- ä¿®æ”¹ï¼šæ›´æ–° Fancybox CSS å¼•å…¥åœ°å€ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css">
    <!-- å¼•å…¥ Font Awesome å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GLM7S1QFLN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GLM7S1QFLN');
</script>

<body>

    <div id="topbar">
        <div id="header">Texture Reference</div>
        <div id="slider-container">
            <input type="range" id="slider" min="50" max="250" value="100">
            <!-- ä½¿ç”¨ Font Awesome çš„ "i" å›¾æ ‡ï¼Œå³ç§» 5px -->
            <button id="info-button" style="background: none; border: none; cursor: pointer; color: white; font-size: 1.5em; margin-left: 20px;">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>
    </div>
    <div id="content">
        <div id="file-tree"></div>
        <div id="gallery"></div>
        <div id="canvas-container">
            <canvas id="canvas"></canvas> <!-- Add canvas for animation -->
        </div>
    </div>
    <div id="error-message" class="error-message">Website is busy, please come back 1 hour later</div>
    <div id="myModal" class="modal">
        <div class="loading-container" id="loading-container">
            <div class="loading" id="loading"></div>
            <div class="loading-text">Loading original resolution...</div>
        </div>
        <img class="modal-content" id="img01">
    </div>
    <div id="info-modal">
        <button id="info-modal-close">âœ–</button>
        <h2>About</h2>
        <!-- ç¬¬ä¸€æ ï¼šç¤¾äº¤åª’ä½“ -->
        <h3>About Me</h3>
        <div class="row">
            <a href="https://x.com/YeHangHarry" target="_blank">
                <img src="https://cdn-icons-png.flaticon.com/512/124/124021.png" alt="Twitter"> Twitter
            </a>
            <a href="https://www.artstation.com/ye-hang" target="_blank">
                <img src="https://cdn.brandfetch.io/artstation.com/fallback/lettermark/theme/dark/h/256/w/256/icon?c=1bfwsmEH20zzEfSNTed" alt="ArtStation"> ArtStation
            </a>
            <a href="https://www.linkedin.com/in/hang-ye?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app" target="_blank">
                <i class="fab fa-linkedin"></i> LinkedIn
            </a>
        </div>
        <!-- ç¬¬äºŒæ ï¼šèµåŠ©ä¿¡æ¯ -->
        <h3>Support Me</h3>
        <div class="row">
            <a href="https://ko-fi.com/yehang" target="_blank">
                <img src="https://storage.ko-fi.com/cdn/logomarkLogo.png" alt="Ko-fi"> Ko-fi
            </a>
            <div id="alipay-container" style="position: relative; display: inline-block;">
                <a href="javascript:void(0)" id="alipay-button">
                    <img src="https://cdn4.iconfinder.com/data/icons/logos-and-brands/512/13_Alipay_logo_logos-512.png" alt="Alipay"> Alipay
                </a>
                <div id="alipay-preview">
                    <img src="https://i.imgur.com/vPykp9X.jpeg" alt="Alipay QR Code">
                </div>
            </div>
        </div>
        <!-- ç¬¬ä¸‰æ ï¼šè¯ä¹¦ä¿¡æ¯ -->
        <div class="license">
            <strong>MIT License</strong><br>
            Copyright (c) 2025 Ye Hang<br><br>
            Permission is hereby granted, free of charge, to any person obtaining a copy
            of this software and associated documentation files (the "Software"), to deal
            in the Software without restriction, including without limitation the rights
            to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
            copies of the Software, and to permit persons to whom the Software is
            furnished to do so, subject to the following conditions:<br><br>
            The above copyright notice and this permission notice shall be included in all
            copies or substantial portions of the Software.<br><br>
            THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
            IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
            FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
            AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
            LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
            OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
            SOFTWARE.
        </div>
    </div>
    <!-- æ”¯ä»˜å®äºŒç»´ç çª—å£ -->
    <div id="alipay-modal">
        <img src="https://i.imgur.com/vPykp9X.jpeg" alt="Alipay QR Code">
    </div>

    <script>
        const jsonUrl = 'https://raw.githubusercontent.com/YeHang-GitHub/Texture-Reference-Photo/main/directory_cache.json';
        let totalSeconds = 0;
        let img = new Image();
        img.crossOrigin = "anonymous";
        let canvas, context;

        async function fetchJsonData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                console.error(error);
                document.getElementById("error-message").style.display = "block";
                throw error;
            }
        }

        async function createFileTree(container, data, level = 0, parentPath = 'Images') {
            const folders = {};

            data.forEach(file => {
                const parts = file.fullsize_path.split('/').slice(1); // Remove 'Images' from the path
                let currentLevel = folders;

                parts.forEach((part, index) => {
                    if (!currentLevel[part]) {
                        currentLevel[part] = index === parts.length - 1 ? file : {};
                    }
                    currentLevel = currentLevel[part];
                });
            });

            function buildTree(container, tree, level, currentPath) {
                const sortedKeys = Object.keys(tree).sort((a, b) => a.localeCompare(b));
                sortedKeys.forEach(key => {
                    const item = document.createElement("div");
                    item.style.marginLeft = `${level * 15}px`;
                    item.classList.add(tree[key].name ? "file" : "folder");
                    item.style.display = "flex";
                    item.style.justifyContent = "space-between";

                    const isDeepestFolder = !Object.keys(tree[key]).some(subKey => typeof tree[key][subKey] === 'object' && !tree[key][subKey].name);
                    const photoCount = tree[key].name ? 0 : countPhotosInFolder(`${currentPath}/${key}`, data);
                    const folderName = document.createElement("span");
                    folderName.textContent = tree[key].name ? "" : (isDeepestFolder ? "ğŸï¸ " : "ğŸ“‚ ") + key;

                    const countSpan = document.createElement("span");
                    countSpan.style.color = "#aaa";
                    countSpan.style.fontWeight = "normal"; // è®©æ•°å­—ä¸åŠ ç²—
                    countSpan.textContent = tree[key].name ? "" : photoCount;

                    item.appendChild(folderName);
                    item.appendChild(countSpan);

                    if (!tree[key].name) {
                        if (isDeepestFolder) {
                            item.onclick = (event) => {
                                event.stopPropagation();
                                document.querySelectorAll('.folder').forEach(folder => folder.classList.remove('selected'));
                                item.classList.add('selected');
                                const newPath = `${currentPath}/${key}`;
                                displayImagesInFolder(newPath, data);
                                document.getElementById("canvas-container").style.display = "none";
                            };
                            container.appendChild(item);
                        } else {
                            const subContainer = document.createElement("div");
                            subContainer.classList.add("hidden", "sub-container");

                            item.onclick = (event) => {
                                event.stopPropagation();
                                document.querySelectorAll('.folder').forEach(folder => folder.classList.remove('selected'));
                                item.classList.add('selected');
                                if (window.getComputedStyle(subContainer).display === 'none') {
                                    subContainer.style.display = 'block';
                                    const height = subContainer.scrollHeight;
                                    subContainer.style.height = '0px';
                                    setTimeout(() => {
                                        subContainer.style.transition = 'height 0.3s ease';
                                        subContainer.style.height = height + 'px';
                                    }, 10);
                                    subContainer.addEventListener('transitionend', function clearHeight(e) {
                                        if (e.propertyName === 'height') {
                                            subContainer.style.height = 'auto';
                                            subContainer.style.transition = '';
                                            subContainer.removeEventListener('transitionend', clearHeight);
                                        }
                                    });
                                } else {
                                    const height = subContainer.scrollHeight;
                                    subContainer.style.height = height + 'px';
                                    setTimeout(() => {
                                        subContainer.style.transition = 'height 0.3s ease';
                                        subContainer.style.height = '0px';
                                    }, 10);
                                    subContainer.addEventListener('transitionend', function hide(e) {
                                        if (e.propertyName === 'height') {
                                            subContainer.style.display = 'none';
                                            subContainer.style.transition = '';
                                            subContainer.removeEventListener('transitionend', hide);
                                        }
                                    });
                                }
                                const newPath = `${currentPath}/${key}`;
                                displayImagesInFolder(newPath, data);
                                document.getElementById("canvas-container").style.display = "none";
                            };
                            container.appendChild(item);
                            container.appendChild(subContainer);
                            buildTree(subContainer, tree[key], level + 1, `${currentPath}/${key}`);
                        }
                    } else {
                        item.onclick = () => {
                            displayImagesInFolder(tree[key].fullsize_path, data);
                        };
                        container.appendChild(item);
                    }
                });
            }

            buildTree(container, folders, level, parentPath);
        }

        function countPhotosInFolder(folderPath, data) {
            return data.filter(file => file.fullsize_path.startsWith(folderPath + '/')).length;
        }

        function collectImagesFromFolder(folderPath, data) {
            return data
                .filter(file => file.fullsize_path.startsWith(folderPath + '/'))
                .sort((a, b) => a.name.localeCompare(b.name)); // æŒ‰æ–‡ä»¶åæ’åº
        }

        // ç€‘å¸ƒæµå¸ƒå±€å®æ—¶è®¡ç®—å‡½æ•°
        function positionThumbnails() {
            const waterfall = document.getElementById("waterfall");
            const gap = 10; // å›¾ç‰‡é—´éš”
            const thumbnails = Array.from(waterfall.getElementsByClassName("thumbnail"));
            if (thumbnails.length === 0) return;
            // ç»Ÿä¸€å®½åº¦ï¼šä»¥ç¬¬ä¸€ä¸ªå›¾ç‰‡çš„å®é™…å®½åº¦ä¸ºå‚ç…§
            const colWidth = thumbnails[0].clientWidth;
            const containerWidth = waterfall.clientWidth;
            let colCount = Math.floor((containerWidth + gap) / (colWidth + gap));
            colCount = Math.max(colCount, 1);
            const colHeights = new Array(colCount).fill(0);

            thumbnails.forEach(img => {
                // æ‰¾å‡ºå½“å‰é«˜åº¦æœ€å°çš„é‚£ä¸€åˆ—
                let minCol = 0;
                let minHeight = colHeights[0];
                for (let i = 1; i < colCount; i++) {
                    if (colHeights[i] < minHeight) {
                        minHeight = colHeights[i];
                        minCol = i;
                    }
                }
                img.style.top = minHeight + "px";
                img.style.left = (minCol * (colWidth + gap)) + "px";
                colHeights[minCol] += img.clientHeight + gap;
            });
            // æ›´æ–° waterfall é«˜åº¦ä»¥é€‚åº”ç€‘å¸ƒæµå¸ƒå±€
            waterfall.style.height = Math.max(...colHeights) + "px";
        }

        // ä¿®æ”¹ slider é»˜è®¤å€¼ï¼Œä¿è¯é»˜è®¤æ¯è¡Œæ˜¾ç¤º5å¼ å›¾ç‰‡
        const slider = document.getElementById("slider");
        slider.min = 1;
        slider.max = 10;
        slider.step = 1;
        slider.value = 6; // è®¡ç®—ï¼š10 - 6 + 1 = 5 å¼ /è¡Œ

        function updateGalleryLayout() {
            const gap = 10; // å›¾ç‰‡é—´éš”
            const slider = document.getElementById("slider");
            // å®é™…æ¯è¡Œå›¾ç‰‡æ•° = (slider.max - slider.value + slider.min)
            const numImagesPerRow = parseInt(slider.max, 10) - parseInt(slider.value, 10) + parseInt(slider.min, 10);
            const waterfall = document.getElementById("waterfall");
            if (!waterfall) return; // æ–°å¢ï¼šå¦‚æœç€‘å¸ƒæµå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ™é€€å‡º
            const containerWidth = waterfall.clientWidth;
            // è®¡ç®—æ¯å¼ å›¾ç‰‡å®½åº¦ï¼Œå–æ•´é¿å…å°æ•°è¯¯å·®
            const newWidth = Math.floor((containerWidth - gap * (numImagesPerRow - 1)) / numImagesPerRow);
            document.querySelectorAll(".thumbnail").forEach(img => {
                img.style.width = newWidth + "px";
                img.style.height = "auto";
            });
            positionThumbnails();
            // æ›´æ–° canvas å°ºå¯¸
            const gallery = document.getElementById("gallery");
            if (canvas) {
                canvas.width = gallery.clientWidth;
                canvas.height = gallery.clientHeight;
            }
        }

        // slider çš„ oninput ä¿æŒä¸å˜
        slider.oninput = () => {
            updateGalleryLayout();
        };

        // ç›‘å¬çª—å£resize
        window.addEventListener("resize", () => {
            clearTimeout(window._resizeTimeout);
            window._resizeTimeout = setTimeout(() => {
                updateGalleryLayout();
            }, 150);
        });

        // ä½¿ç”¨ window.onload ç¡®ä¿é¡µé¢å…¨éƒ¨åŠ è½½åæ›´æ–°å¸ƒå±€
        window.addEventListener("load", () => {
            updateGalleryLayout();
        });

        // æ–°å¢ï¼šé€šè¿‡ XMLHttpRequest åŠ è½½å›¾ç‰‡ï¼Œå¹¶é€æ­¥å›è°ƒè¿›åº¦
        function loadImageWithProgress(url, onProgress, onComplete, onError) {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.responseType = "blob";
            xhr.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    onProgress(percentComplete);
                }
            };
            xhr.onload = function() {
                if (xhr.status === 200) {
                    onComplete(xhr.response);
                } else {
                    onError(new Error("Status: " + xhr.status));
                }
            };
            xhr.onerror = function() {
                onError(new Error("XHR error"));
            };
            xhr.send();
        }

        async function displayImagesInFolder(folderPath, data) {
            const gallery = document.getElementById("gallery");
            gallery.innerHTML = "";
            const waterfall = document.createElement("div");
            waterfall.id = "waterfall";
            gallery.appendChild(waterfall);
            updateGalleryLayout();
            const files = collectImagesFromFolder(folderPath, data);
            console.log("Debug: files to display", files);
            document.getElementById("slider-container").style.display = "flex";
            const gap = 10;
            const slider = document.getElementById("slider");
            const numImagesPerRow = parseInt(slider.max, 10) - parseInt(slider.value, 10) + parseInt(slider.min, 10);
            const containerWidth = waterfall.clientWidth;
            const targetWidth = Math.floor((containerWidth - gap * (numImagesPerRow - 1)) / numImagesPerRow);
            
            files.forEach(file => {
                const imgEl = document.createElement("img");
                imgEl.crossOrigin = "anonymous"; // æ–°å¢ï¼šæ·»åŠ è·¨åŸŸå±æ€§
                imgEl.classList.add("thumbnail");
                imgEl.style.width = targetWidth + "px";
                imgEl.style.height = "auto";
                // æ˜¾ç¤ºç¼©ç•¥å›¾
                imgEl.src = `https://raw.githubusercontent.com/YeHang-GitHub/Texture-Reference-Photo/main/${file.thumbnail_path}`;
                console.log("Debug: thumbnail src =", imgEl.src);
                imgEl.onerror = (e) => {
                    console.error("Error loading thumbnail for", file.thumbnail_path, "URL:", imgEl.src, e);
                };
                imgEl.onload = () => {
                    positionThumbnails();
                    console.log("Debug: thumbnail loaded", file.thumbnail_path);
                };

                const aEl = document.createElement("a");
                // ä½¿ç”¨ Fancybox å¤„ç†ï¼Œå¹¶è®¾ç½®å¿…éœ€çš„å±æ€§
                aEl.setAttribute("data-fancybox", "gallery");
                aEl.setAttribute("data-type", "image");
                aEl.setAttribute("data-src", `https://raw.githubusercontent.com/YeHang-GitHub/Texture-Reference-Photo/main/${file.fullsize_path}`);
                aEl.setAttribute("data-original", `https://raw.githubusercontent.com/YeHang-GitHub/Texture-Reference-Photo/main/${file.fullsize_path}`);
                aEl.appendChild(imgEl);
                waterfall.appendChild(aEl);
            });
        }

        function draw(delta) {
            totalSeconds += delta;
            const zoomFactor = 0.4; // Zoom out a little bit
            const x = -1 * (img.width * zoomFactor - canvas.width) / 2 * (1 + Math.cos(totalSeconds / (4 * Math.PI))); // Slow down by half
            const y = -1 * (img.height * zoomFactor - canvas.height) / 2 * (1 + -Math.sin(totalSeconds / (4 * Math.PI))); // Slow down by half

            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(img, x, y, img.width * zoomFactor, img.height * zoomFactor); // Apply zoom factor
        }

        function animate() {
            let lastTime = 0;
            function frame(time) {
                const delta = (time - lastTime) / 1000;
                lastTime = time;
                draw(delta);
                requestAnimationFrame(frame);
            }
            requestAnimationFrame(frame);
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const fileTree = document.getElementById("file-tree");
            const data = await fetchJsonData(jsonUrl);
            await createFileTree(fileTree, data);

            const modal = document.getElementById("myModal");
            const modalImg = document.getElementById("img01");

            modal.onclick = (event) => {
                if (event.target !== modalImg) {
                    modal.classList.remove("show");
                    modalImg.classList.remove("enlarged");
                }
            };

            modalImg.onclick = (event) => {
                const rect = modalImg.getBoundingClientRect();
                const offsetX = event.clientX - rect.left;
                const offsetY = event.clientY - rect.top;
                const originX = (offsetX / rect.width) * 100;
                const originY = (offsetY / rect.height) * 100;
                modalImg.style.transformOrigin = `${originX}% ${originY}%`;
                modalImg.classList.toggle("enlarged");
            };

            // é…ç½®sliderå¹¶æ›´æ–°åˆå§‹å¸ƒå±€
            slider.min = 1;
            slider.max = 10;
            slider.step = 1;
            slider.value = 6; // é»˜è®¤æ¯è¡Œ5å¼ ï¼ˆä¸­å›¾ï¼‰
            updateGalleryLayout();

            // é€‰å–éšæœºå›¾ç‰‡ç”¨äºcanvasåŠ¨ç”»
            const randomImage = data[Math.floor(Math.random() * data.length)];
            img.src = `https://raw.githubusercontent.com/YeHang-GitHub/Texture-Reference-Photo/main/${randomImage.fullsize_path}`;

            // è®¾ç½®canvas
            canvas = document.getElementById("canvas");
            context = canvas.getContext("2d");

            img.onload = () => {
                const gallery = document.getElementById("gallery");
                canvas.width = gallery.clientWidth;
                canvas.height = gallery.clientHeight;
                animate();
            };

            document.getElementById("info-button").addEventListener("click", () => {
                document.getElementById("info-modal").style.display = "block";
            });

            document.getElementById("info-modal-close").addEventListener("click", () => {
                document.getElementById("info-modal").style.display = "none";
            });

            document.getElementById("alipay-button").addEventListener("click", () => {
                document.getElementById("alipay-modal").style.display = "block";
            });

            document.getElementById("alipay-modal").addEventListener("click", () => {
                document.getElementById("alipay-modal").style.display = "none";
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script>
    <script>
      Fancybox.bind("[data-fancybox='gallery']", {
          Toolbar: false,  // ç¦ç”¨å³ä¸Šè§’å·¥å…·æ 
          preload: 0,     // ç¦ç”¨é¢„åŠ è½½
      });
    </script>

</body>
</html>
